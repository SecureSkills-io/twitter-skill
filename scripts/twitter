#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const CONFIG_DIR = path.join(process.env.HOME, '.config/twitter-skill');
const COOKIES_FILE = path.join(CONFIG_DIR, 'cookies.json');
const TEMP_FILE = path.join(CONFIG_DIR, '.temp-action.json');
const LIB_DIR = path.join(__dirname, '..', 'lib');

function ensureConfigDir() {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true, mode: 0o700 });
  }
}

function loadCookies() {
  if (process.env.TWITTER_COOKIES_JSON) {
    try { return JSON.parse(process.env.TWITTER_COOKIES_JSON); } catch (e) {}
  }
  if (fs.existsSync(COOKIES_FILE)) {
    try { return JSON.parse(fs.readFileSync(COOKIES_FILE, 'utf8')); } catch (e) {}
  }
  return null;
}

function saveCookies(cookies) {
  ensureConfigDir();
  fs.writeFileSync(COOKIES_FILE, JSON.stringify(cookies, null, 2), { mode: 0o600 });
}

function formatCookies(cookies) {
  if (Array.isArray(cookies)) return cookies;
  return [
    { name: 'auth_token', value: cookies.auth_token, domain: '.x.com', path: '/', secure: true, httpOnly: true },
    { name: 'ct0', value: cookies.ct0, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'twid', value: cookies.twid, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'guest_id', value: cookies.guest_id, domain: '.x.com', path: '/', secure: true, httpOnly: false }
  ].filter(c => c.value);
}

function runAutomation(command) {
  const scriptPath = path.join(LIB_DIR, 'twitter-automation.js');
  return execSync(`node "${scriptPath}" ${command}`, { encoding: 'utf8', timeout: 60000 });
}

async function postTweet(text) {
  const cookies = loadCookies();
  if (!cookies) { console.error('No cookies. Run: twitter auth'); process.exit(1); }
  
  console.log('Posting tweet...');
  
  // Write action to temp file
  const action = { text, cookies: formatCookies(cookies) };
  fs.writeFileSync(TEMP_FILE, JSON.stringify(action));
  
  try {
    const output = runAutomation('post');
    console.log(output);
    
    // Parse cookies from output (between COOKIES_START and COOKIES_END)
    const match = output.match(/COOKIES_START\n([\s\S]+?)\nCOOKIES_END/);
    if (match) {
      saveCookies(JSON.parse(match[1]));
      console.log('‚úì Done - cookies refreshed');
    } else {
      console.log('‚úì Posted (check for errors above)');
    }
  } catch (e) {
    console.error('Failed:', e.message);
    process.exit(1);
  }
}

async function extractCookies() {
  console.log('Extracting...');
  try {
    const output = runAutomation('extract');
    saveCookies(JSON.parse(output));
    console.log('‚úì Saved');
  } catch (e) {
    console.error('Failed:', e.message);
    process.exit(1);
  }
}

function showWhoami() {
  const cookies = loadCookies();
  if (!cookies) { console.log('Not authenticated'); return; }
  const isArray = Array.isArray(cookies);
  const hasAuth = isArray ? cookies.some(c => c.name === 'auth_token') : !!cookies.auth_token;
  console.log('Authenticated:', hasAuth ? '‚úì' : '‚úó');
}

function saveAuth(token, ct0, twid = '', guestId = '') {
  ensureConfigDir();
  saveCookies([
    { name: 'auth_token', value: token, domain: '.x.com', path: '/', secure: true, httpOnly: true },
    { name: 'ct0', value: ct0, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'twid', value: twid, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'guest_id', value: guestId, domain: '.x.com', path: '/', secure: true, httpOnly: false }
  ]);
  console.log('‚úì Saved');
}

function showHelp() {
  console.log(`
üê¶ twitter-skill

Commands:
  auth <token> <ct0>         Save credentials
  post "text"                Post a tweet
  extract                    Extract fresh cookies
  whoami                     Show auth status
`);
}

async function main() {
  const cmd = process.argv[2];
  switch (cmd) {
    case 'auth':
      if (process.argv[3] === '--cookies-json') {
        saveCookies(JSON.parse(process.argv[4]));
      } else if (process.argv[3] && process.argv[4]) {
        saveAuth(process.argv[3], process.argv[4], process.argv[5], process.argv[6]);
      } else showHelp();
      break;
    case 'post': await postTweet(process.argv[3]); break;
    case 'extract': await extractCookies(); break;
    case 'whoami': showWhoami(); break;
    default: showHelp();
  }
}

main().catch(e => { console.error(e.message); process.exit(1); });