#!/usr/bin/env node
/**
 * twitter-skill ‚Äî Twitter/X CLI for OpenClaw agents
 * 
 * Usage: twitter <command> [options]
 * 
 * Commands:
 *   auth                          Save credentials
 *   post <text> [--media <file>]  Post a tweet
 *   thread <file|text>            Post a thread (text with --- separators or file)
 *   reply <url> <text>            Reply to a tweet
 *   like <url>                    Like a tweet
 *   retweet <url>                 Retweet
 *   search <query>                Search tweets
 *   mentions                      Check mentions
 *   whoami                        Show current account
 *   extract                       Extract fresh cookies from browser
 * 
 * Environment:
 *   TWITTER_AUTH_TOKEN            Auth token cookie
 *   TWITTER_CT0                   CT0 cookie
 *   TWITTER_COOKIES_JSON          Full cookies JSON string
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const CONFIG_DIR = path.join(process.env.HOME, '.config/twitter-skill');
const COOKIES_FILE = path.join(CONFIG_DIR, 'cookies.json');
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');

// Ensure config directory exists
function ensureConfigDir() {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true, mode: 0o700 });
  }
}

// Load cookies from file or env
function loadCookies() {
  // Check env first
  if (process.env.TWITTER_COOKIES_JSON) {
    try {
      return JSON.parse(process.env.TWITTER_COOKIES_JSON);
    } catch (e) {
      console.error('Invalid TWITTER_COOKIES_JSON');
    }
  }

  // Check individual env vars
  if (process.env.TWITTER_AUTH_TOKEN && process.env.TWITTER_CT0) {
    return {
      auth_token: process.env.TWITTER_AUTH_TOKEN,
      ct0: process.env.TWITTER_CT0,
      twid: process.env.TWITTER_TWID,
      guest_id: process.env.TWITTER_GUEST_ID
    };
  }

  // Load from file
  if (fs.existsSync(COOKIES_FILE)) {
    try {
      const data = fs.readFileSync(COOKIES_FILE, 'utf8');
      return JSON.parse(data);
    } catch (e) {
      console.error('Failed to load cookies:', e.message);
    }
  }

  return null;
}

// Save cookies to file
function saveCookies(cookies) {
  ensureConfigDir();
  fs.writeFileSync(COOKIES_FILE, JSON.stringify(cookies, null, 2), { mode: 0o600 });
}

// Save full cookie array (from browser extraction)
function saveCookiesArray(cookiesArray) {
  ensureConfigDir();
  fs.writeFileSync(COOKIES_FILE, JSON.stringify(cookiesArray, null, 2), { mode: 0o600 });
  console.log('‚úì Cookies saved to', COOKIES_FILE);
}

// Extract key cookies from array
function extractKeyCookies(cookiesArray) {
  const keyCookies = {};
  for (const cookie of cookiesArray) {
    if (['auth_token', 'ct0', 'twid', 'guest_id'].includes(cookie.name)) {
      keyCookies[cookie.name] = cookie.value;
    }
  }
  return keyCookies;
}

// Format cookies for browser injection
function formatCookiesForBrowser(cookies) {
  if (Array.isArray(cookies)) {
    return cookies.filter(c => 
      ['auth_token', 'ct0', 'twid', 'guest_id', 'att', 'kdt', '_twitter_sess'].includes(c.name)
    );
  }
  // Convert object to array format
  return [
    { name: 'auth_token', value: cookies.auth_token, domain: '.x.com', path: '/', secure: true, httpOnly: true },
    { name: 'ct0', value: cookies.ct0, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'twid', value: cookies.twid, domain: '.x.com', path: '/', secure: true, httpOnly: false },
    { name: 'guest_id', value: cookies.guest_id, domain: '.x.com', path: '/', secure: true, httpOnly: false }
  ].filter(c => c.value);
}

// Extract cookies from running browser
async function extractCookiesFromBrowser() {
  console.log('Extracting cookies from browser...');
  
  // Use Playwright to get cookies
  const script = `
    const { chromium } = require('playwright');
    (async () => {
      const browser = await chromium.connectOverCDP('http://127.0.0.1:18800');
      const context = browser.contexts()[0];
      const cookies = await context.cookies('https://x.com');
      console.log(JSON.stringify(cookies, null, 2));
      await browser.disconnect();
    })();
  `;
  
  try {
    const result = execSync('node -e ' + JSON.stringify(script), { encoding: 'utf8', timeout: 10000 });
    const cookies = JSON.parse(result);
    saveCookiesArray(cookies);
    return cookies;
  } catch (e) {
    console.error('Failed to extract cookies:', e.message);
    console.log('Make sure browser is running and connected to CDP port 18800');
    return null;
  }
}

// Post a tweet using browser automation
async function postTweet(text, mediaFiles = []) {
  const cookies = loadCookies();
  if (!cookies) {
    console.error('No credentials found. Run: twitter auth');
    process.exit(1);
  }

  console.log('Posting tweet...');
  
  const cookieArray = formatCookiesForBrowser(cookies);
  const cookieScript = cookieArray.map(c => {
    const attrs = [];
    if (c.secure) attrs.push('secure');
    if (c.httpOnly) attrs.push('httpOnly');
    if (c.sameSite) attrs.push(`sameSite: '${c.sameSite}'`);
    return `document.cookie = '${c.name}=${c.value}; domain=${c.domain}; path=${c.path}${attrs.length ? '; ' + attrs.join('; ') : ''}'`;
  }).join(';\n    ');

  const script = `
    const { chromium } = require('playwright');
    (async () => {
      const browser = await chromium.connectOverCDP('http://127.0.0.1:18800');
      const page = await browser.newPage();
      
      // Set cookies
      await page.context().addCookies(${JSON.stringify(cookieArray)});
      
      // Navigate to X
      await page.goto('https://x.com/home', { waitUntil: 'networkidle' });
      await page.waitForTimeout(2000);
      
      // Click compose
      await page.click('[data-testid="tweetTextarea_0"], [role="textbox"][contenteditable="true"]');
      await page.waitForTimeout(500);
      
      // Type text
      await page.keyboard.type(${JSON.stringify(text)});
      await page.waitForTimeout(500);
      
      // Click post button
      const postBtn = await page.$('button[data-testid="tweetButtonInline"], button[data-testid="tweetButton"]');
      if (postBtn) {
        await postBtn.click();
        await page.waitForTimeout(3000);
        console.log('Tweet posted successfully');
      } else {
        console.log('Post button not found');
      }
      
      await page.close();
      await browser.disconnect();
    })().catch(e => {
      console.error('Error:', e.message);
      process.exit(1);
    });
  `;
  
  try {
    execSync('node -e ' + JSON.stringify(script), { encoding: 'utf8', timeout: 30000 });
    
    // Extract fresh cookies after posting
    console.log('Extracting updated cookies...');
    await extractCookiesFromBrowser();
    
  } catch (e) {
    console.error('Failed to post:', e.message);
    process.exit(1);
  }
}

// Post a thread
async function postThread(content) {
  const parts = content.split(/\n?---\n?/); // Split on --- separators
  
  console.log(`Posting thread with ${parts.length} tweets...`);
  
  for (let i = 0; i < parts.length; i++) {
    const text = parts[i].trim();
    if (!text) continue;
    
    console.log(`\n[Tweet ${i + 1}/${parts.length}]`);
    await postTweet(text);
    
    if (i < parts.length - 1) {
      await new Promise(r => setTimeout(r, 2000)); // Delay between posts
    }
  }
  
  console.log('\n‚úì Thread posted successfully');
}

// Reply to a tweet
async function replyToTweet(url, text) {
  const cookies = loadCookies();
  if (!cookies) {
    console.error('No credentials found. Run: twitter auth');
    process.exit(1);
  }

  console.log('Posting reply...');
  
  const cookieArray = formatCookiesForBrowser(cookies);
  
  const script = `
    const { chromium } = require('playwright');
    (async () => {
      const browser = await chromium.connectOverCDP('http://127.0.0.1:18800');
      const page = await browser.newPage();
      
      await page.context().addCookies(${JSON.stringify(cookieArray)});
      await page.goto(${JSON.stringify(url)}, { waitUntil: 'networkidle' });
      await page.waitForTimeout(2000);
      
      // Click reply button
      const replyBtn = await page.$('button[data-testid="reply"], [data-testid="reply"]');
      if (replyBtn) await replyBtn.click();
      await page.waitForTimeout(1000);
      
      // Type reply
      const textbox = await page.$('[data-testid="tweetTextarea_0"], [role="textbox"][contenteditable="true"]');
      if (textbox) {
        await textbox.click();
        await page.keyboard.type(${JSON.stringify(text)});
        await page.waitForTimeout(500);
        
        // Submit
        const postBtn = await page.$('button[data-testid="tweetButtonInline"]');
        if (postBtn) await postBtn.click();
        await page.waitForTimeout(3000);
        console.log('Reply posted');
      }
      
      await page.close();
      await browser.disconnect();
    })();
  `;
  
  try {
    execSync('node -e ' + JSON.stringify(script), { encoding: 'utf8', timeout: 30000 });
    await extractCookiesFromBrowser();
  } catch (e) {
    console.error('Failed to reply:', e.message);
    process.exit(1);
  }
}

// Like a tweet
async function likeTweet(url) {
  const cookies = loadCookies();
  if (!cookies) {
    console.error('No credentials found. Run: twitter auth');
    process.exit(1);
  }

  const cookieArray = formatCookiesForBrowser(cookies);
  
  const script = `
    const { chromium } = require('playwright');
    (async () => {
      const browser = await chromium.connectOverCDP('http://127.0.0.1:18800');
      const page = await browser.newPage();
      
      await page.context().addCookies(${JSON.stringify(cookieArray)});
      await page.goto(${JSON.stringify(url)}, { waitUntil: 'networkidle' });
      await page.waitForTimeout(2000);
      
      const likeBtn = await page.$('button[data-testid="like"], [data-testid="like"]');
      if (likeBtn) {
        await likeBtn.click();
        await page.waitForTimeout(1000);
        console.log('Liked');
      } else {
        console.log('Already liked or button not found');
      }
      
      await page.close();
      await browser.disconnect();
    })();
  `;
  
  try {
    execSync('node -e ' + JSON.stringify(script), { encoding: 'utf8', timeout: 30000 });
    await extractCookiesFromBrowser();
  } catch (e) {
    console.error('Failed to like:', e.message);
    process.exit(1);
  }
}

// Show current account
function showWhoami() {
  const cookies = loadCookies();
  if (!cookies) {
    console.log('Not authenticated. Run: twitter auth');
    return;
  }
  
  // Handle both array and object formats
  let authToken, ct0, twid;
  if (Array.isArray(cookies)) {
    authToken = cookies.find(c => c.name === 'auth_token')?.value;
    ct0 = cookies.find(c => c.name === 'ct0')?.value;
    twid = cookies.find(c => c.name === 'twid')?.value;
  } else {
    authToken = cookies.auth_token;
    ct0 = cookies.ct0;
    twid = cookies.twid;
  }
  
  console.log('Authenticated with cookies:');
  console.log('  auth_token:', authToken ? '‚úì present' : '‚úó missing');
  console.log('  ct0:', ct0 ? '‚úì present' : '‚úó missing');
  console.log('  twid:', twid ? '‚úì present' : '‚úó missing');
  console.log('\nCookies file:', COOKIES_FILE);
  console.log('Cookies count:', Array.isArray(cookies) ? cookies.length : Object.keys(cookies).length);
}

// Save auth credentials
function saveAuth(authToken, ct0, twid = '', guestId = '') {
  ensureConfigDir();
  const cookies = {
    auth_token: authToken,
    ct0: ct0,
    twid: twid,
    guest_id: guestId
  };
  saveCookies(cookies);
  console.log('‚úì Credentials saved');
}

// Main CLI
async function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  switch (command) {
    case 'auth':
      if (args[1] === '--cookies-json') {
        saveCookiesArray(JSON.parse(args[2]));
      } else if (args[1] && args[2]) {
        saveAuth(args[1], args[2], args[3], args[4]);
      } else {
        console.log('Usage: twitter auth <auth_token> <ct0> [twid] [guest_id]');
        console.log('   or: twitter auth --cookies-json \'<json>\'');
      }
      break;

    case 'post':
    case 'tweet':
      if (!args[1]) {
        console.error('Usage: twitter post "Your tweet text"');
        process.exit(1);
      }
      await postTweet(args[1]);
      break;

    case 'thread':
      if (!args[1]) {
        console.error('Usage: twitter thread "Tweet 1\n---\nTweet 2\n---\nTweet 3"');
        console.log('   or: twitter thread file.txt');
        process.exit(1);
      }
      let content;
      if (fs.existsSync(args[1])) {
        content = fs.readFileSync(args[1], 'utf8');
      } else {
        content = args[1];
      }
      await postThread(content);
      break;

    case 'reply':
      if (!args[1] || !args[2]) {
        console.error('Usage: twitter reply <tweet-url> "Your reply"');
        process.exit(1);
      }
      await replyToTweet(args[1], args[2]);
      break;

    case 'like':
      if (!args[1]) {
        console.error('Usage: twitter like <tweet-url>');
        process.exit(1);
      }
      await likeTweet(args[1]);
      break;

    case 'extract':
      await extractCookiesFromBrowser();
      break;

    case 'whoami':
      showWhoami();
      break;

    case 'help':
    default:
      console.log(`
üê¶ twitter-skill ‚Äî Twitter/X CLI for OpenClaw agents

Commands:
  auth <token> <ct0> [twid]   Save credentials
  auth --cookies-json '<json>' Save full cookie array
  post "text"                 Post a tweet
  thread "text---text"        Post a thread (split by ---)
  thread file.txt             Post thread from file
  reply <url> "text"          Reply to a tweet
  like <url>                  Like a tweet
  extract                     Extract fresh cookies from browser
  whoami                      Show current account
  help                        Show this help

Environment:
  TWITTER_AUTH_TOKEN          Auth token cookie
  TWITTER_CT0                 CT0 cookie
  TWITTER_COOKIES_JSON        Full cookies JSON

Examples:
  twitter auth 799bb... 1b895...
  twitter post "Hello world!"
  twitter thread "Tweet 1---Tweet 2---Tweet 3"
  twitter reply https://x.com/user/status/123 "Nice post!"
  twitter extract
`);
  }
}

main().catch(e => {
  console.error('Error:', e.message);
  process.exit(1);
});